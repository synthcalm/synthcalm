<script>
document.addEventListener("DOMContentLoaded", () => {
    // === CLOCK ===
    function updateDateTime() {
        const now = new Date();
        const formatted = now.toLocaleString(undefined, {
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            hour12: false
        });
        document.getElementById('dateTimeDisplay').textContent = formatted;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // === VOICE RECORDING & WAVEFORM ===
    const canvas = document.getElementById("waveform");
    const ctx = canvas.getContext("2d");
    canvas.width = canvas.offsetWidth || 300;
    canvas.height = 160;

    let analyser, dataArray, audioCtx, source, micStream, recognition;
    const startBtn = document.getElementById("startVoice");
    const countdownDisplay = document.getElementById("countdownDisplay");
    let isRecording = false;
    let countdownInterval;

    function drawWaveform() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#ffff00";
        ctx.lineWidth = 0.5;

        for (let i = canvas.width / 10; i < canvas.width; i += canvas.width / 10) {
            ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
        }
        for (let i = canvas.height / 4; i < canvas.height; i += canvas.height / 4) {
            ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke();
        }

        if (analyser) {
            requestAnimationFrame(drawWaveform);
            analyser.getByteTimeDomainData(dataArray);
            ctx.strokeStyle = "#ffff00";
            ctx.lineWidth = 2;
            ctx.beginPath();
            const sliceWidth = canvas.width / dataArray.length;
            let x = 0;
            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0;
                const y = (v * canvas.height) / 2;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
        }
    }
    drawWaveform();

    async function startRecording() {
        if (isRecording) return stopRecording();

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return alert("Please use Chrome. Voice not supported in this browser.");

        try {
            micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            source = audioCtx.createMediaStreamSource(micStream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            dataArray = new Uint8Array(analyser.fftSize);
            source.connect(analyser);
            drawWaveform();

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.onresult = (e) => {
                const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
                document.getElementById("activityInput").value = transcript;
            };
            recognition.onerror = (e) => alert("Speech error: " + e.error);
            recognition.onend = () => { if (isRecording) recognition.start(); };

            recognition.start();
            isRecording = true;
            startBtn.classList.add("recording");
            startBtn.textContent = "Stop Voice";
            startCountdown();

        } catch (err) {
            alert("Mic error: " + err.message);
            stopRecording();
        }
    }

    function stopRecording() {
        if (recognition) recognition.stop();
        if (micStream) micStream.getTracks().forEach(track => track.stop());
        if (audioCtx) audioCtx.close();
        analyser = null;
        isRecording = false;
        startBtn.classList.remove("recording");
        startBtn.textContent = "Start Voice";
        clearInterval(countdownInterval);
        countdownDisplay.textContent = "00:60";
    }

    function startCountdown() {
        let seconds = 60;
        countdownDisplay.textContent = `00:${seconds}`;
        countdownInterval = setInterval(() => {
            seconds--;
            countdownDisplay.textContent = `00:${seconds < 10 ? "0" + seconds : seconds}`;
            if (seconds <= 0) stopRecording();
        }, 1000);
    }

    startBtn.addEventListener("click", startRecording);

    // === IMAGE GENERATION ===
    document.getElementById("generate").addEventListener("click", async () => {
        const prompt = document.getElementById("activityInput").value.trim();
        const style = document.getElementById("styleSelect").value;
        const generateBtn = document.getElementById("generate");

        if (!prompt) return alert("Please enter a description.");
        if (style === "none") return alert("Please choose an art style.");

        generateBtn.disabled = true;
        document.getElementById("thinking").style.display = "block";

        try {
            const response = await fetch('https://synthcalm-a2n7.onrender.com/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, style })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error ${response.status}`);
            }

            const data = await response.json();
            const image = data.image;
            document.getElementById("generatedImage").src = image;
            document.getElementById("generatedImage").style.display = "block";

        } catch (error) {
            alert("Failed to generate image: " + error.message);
        } finally {
            generateBtn.disabled = false;
            document.getElementById("thinking").style.display = "none";
        }
    });

    // === MOOD SAVE ===
    document.getElementById("saveMood").addEventListener("click", () => {
        const mood = document.getElementById("activityInput").value;
        const imageData = document.getElementById("generatedImage").src;
        const moodHistory = JSON.parse(localStorage.getItem('moodHistory') || '[]');
        moodHistory.push({ mood, imageData, timestamp: new Date().toISOString() });
        localStorage.setItem('moodHistory', JSON.stringify(moodHistory));
        displayMoodHistory();
    });

    function displayMoodHistory() {
        const moodHistory = JSON.parse(localStorage.getItem('moodHistory') || '[]');
        const moodHistoryDiv = document.getElementById('moodHistory');
        moodHistoryDiv.innerHTML = '';
        moodHistory.forEach(item => {
            const moodEntry = document.createElement('div');
            moodEntry.innerHTML = `<p>${item.timestamp}: ${item.mood}</p><img src="${item.imageData}" style="max-width: 100px;">`;
            moodHistoryDiv.appendChild(moodEntry);
        });
    }
    displayMoodHistory();

    document.getElementById("clear").addEventListener("click", () => {
        document.getElementById("activityInput").value = "";
        document.getElementById("generatedImage").style.display = "none";
    });

    document.getElementById("styleSelect").addEventListener("click", () => {
        document.getElementById("styleSelect").classList.add("active");
    });
    document.getElementById("styleSelect").addEventListener("change", () => {
        document.getElementById("styleSelect").classList.remove("active");
    });

    function addButtonActiveFeedback(elementId) {
        const el = document.getElementById(elementId);
        el.classList.add("active");
        setTimeout(() => el.classList.remove("active"), 500);
    }

    document.getElementById("saveMood").addEventListener("click", () => addButtonActiveFeedback("saveMood"));
    document.getElementById("synthCalmHome").addEventListener("click", () => addButtonActiveFeedback("synthCalmHome"));
    document.getElementById("generate").addEventListener("click", () => addButtonActiveFeedback("generate"));
});
</script>
