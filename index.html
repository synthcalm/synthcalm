<script>
// üïí Clock based on user's time zone
function updateLocalDateTime() {
  const now = new Date();
  const options = {
    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit',
    hour12: false
  };
  const formatted = new Intl.DateTimeFormat('default', options).format(now);
  document.getElementById('dateTimeDisplay').textContent = formatted;
}
setInterval(updateLocalDateTime, 1000);
updateLocalDateTime();

// üé§ Start voice recognition
let recognition, isRecording = false;
const countdownDisplay = document.getElementById("countdownDisplay");
let countdownInterval;

document.getElementById("startVoice").addEventListener("click", () => {
  console.log("Start Voice button clicked"); // Debug log
  if (!isRecording) {
    startRecording();
  } else {
    stopRecording();
  }
});

function startRecording() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    console.error("Web Speech API not supported in this browser.");
    alert("Web Speech API not supported in this browser. Please use a supported browser like Chrome.");
    return;
  }

  console.log("Starting voice recognition"); // Debug log
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = () => console.log("Recognition started"); // Debug log
  recognition.onresult = (e) => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join("");
    document.getElementById("activityInput").value = transcript;
    console.log("Transcript:", transcript); // Debug log
  };

  recognition.onerror = (e) => {
    console.error("Speech error:", e.error);
    if (e.error === "no-speech") {
      console.log("No speech detected");
    } else if (e.error === "not-allowed") {
      alert("Microphone access denied. Please allow microphone permissions.");
    }
  };
  recognition.onend = () => {
    console.log("Recognition ended");
    if (isRecording) recognition.start(); // Restart if still recording
  };

  try {
    recognition.start();
    isRecording = true;
    document.getElementById("startVoice").textContent = "Stop Voice";
    startCountdown();
  } catch (error) {
    console.error("Error starting recognition:", error);
    alert("Failed to start voice recording: " + error.message);
  }
}

function stopRecording() {
  if (recognition) {
    recognition.stop();
    console.log("Recording stopped manually"); // Debug log
  }
  isRecording = false;
  document.getElementById("startVoice").textContent = "Start Voice";
  clearInterval(countdownInterval);
  countdownDisplay.textContent = "00:60";
}

function startCountdown() {
  let seconds = 60;
  countdownDisplay.textContent = `00:${seconds}`;
  countdownInterval = setInterval(() => {
    seconds--;
    countdownDisplay.textContent = `00:${seconds < 10 ? "0" + seconds : seconds}`;
    if (seconds <= 0) stopRecording();
  }, 1000);
}

// üé® Image generation (unchanged)
document.getElementById("generate").addEventListener("click", () => {
  const mood = document.getElementById("activityInput").value;
  const style = document.getElementById("styleSelect").value;
  const img = document.getElementById("generatedImage");

  if (!mood || style === "none") {
    alert("Please enter your mood and select a style.");
    return;
  }

  document.getElementById("thinking").style.display = "block";
  setTimeout(() => {
    document.getElementById("thinking").style.display = "none";
    img.src = `https://via.placeholder.com/400x300/000000/0ff?text=${encodeURIComponent(style)}`;
    img.style.display = "block";
  }, 2000);
});

// üíæ Save to mood history (unchanged)
document.getElementById("saveMood").addEventListener("click", () => {
  const moodText = document.getElementById("activityInput").value;
  const timestamp = new Date().toLocaleString();
  const img = document.getElementById("generatedImage");
  const imgSrc = img && img.src ? img.src : 'https://via.placeholder.com/40x40/000000/0ff?text=üñºÔ∏è';

  const entry = document.createElement("div");
  entry.className = "history-entry";
  entry.innerHTML = `
    <img src="${imgSrc}" style="width:40px;height:40px;object-fit:cover;border:1px solid #0ff;margin-right:8px;" />
    <span style="color:#0ff;flex-grow:1;">${timestamp}: ${moodText}</span>
    <button onclick="this.parentElement.remove()" style="margin-left:8px;">Delete</button>
  `;
  entry.style.display = "flex";
  entry.style.alignItems = "center";
  entry.style.marginBottom = "8px";

  document.getElementById("moodHistory").prepend(entry);
});

// üßπ Clear input (unchanged)
document.getElementById("clear").addEventListener("click", () => {
  document.getElementById("activityInput").value = "";
  document.getElementById("generatedImage").style.display = "none";
});
</script>
