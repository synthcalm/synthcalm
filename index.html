<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mood Into Art</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #000;
            color: #0ff;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .instructions {
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .seven-segment {
            font-family: 'Courier New', monospace;
            background-color: #111;
            padding: 5px 10px;
            border-radius: 4px;
            color: #0ff;
        }

        .footer-bar {
            display: flex;
            justify-content: space-between;
        }

        textarea, select, button, input[type="file"] {
            background-color: #111;
            color: #0ff;
            border: 1px solid #0ff;
            padding: 8px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .button {
            flex: 1;
            cursor: pointer;
        }

        #generatedImage {
            display: none;
            max-width: 100%;
            height: auto;
            margin-top: 20px;
        }

        #moodHistory {
            margin-top: 20px;
        }

        .history-entry {
            border-bottom: 1px solid #0ff;
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        #waveform {
            width: 100%;
            height: 160px;
            background: black;
            margin-bottom: 10px;
        }

        #thinking{
            display:none;
            text-align: center;
            color: #0ff;
        }

        #startVoice.recording {
            border-color: magenta;
            color: magenta;
        }

    </style>
</head>
<body>
<div class="container">
    <p class="instructions">1. Press "Start Voice", describe your mood. 2. Choose style. 3. Generate Image.</p>

    <canvas id="waveform"></canvas>

    <div class="footer-bar">
        <div id="dateTimeDisplay" class="seven-segment"></div>
        <div id="countdownDisplay" class="seven-segment">00:60</div>
    </div>

    <textarea id="activityInput" rows="4" placeholder="Describe your mood..."></textarea>
    <input type="file" id="imageInput" accept="image/*">

    <div class="button-group">
        <button class="button" id="startVoice">Start Voice</button>
        <button class="button" id="clear">Clear</button>
        <select id="styleSelect">
            <option value="none" selected disabled>Choose Style</option>
            <option value="photo">Hyper-realistic Photo</option>
            <option value="anime">Japanese Anime Style</option>
            <option value="abstract">Abstract</option>
            <option value="surrealism">Surrealism</option>
            <option value="post-modern">Post-modern</option>
            <option value="cyberpunk">Cyberpunk</option>
            <option value="arabic-calligraphy">Arabic Calligraphy</option>
            <option value="chinese-calligraphy">Chinese Calligraphy</option>
            <option value="japanese-calligraphy">Japanese Calligraphy</option>
            <option value="marvel">Marvel Comic</option>
            <option value="art-deco">Art Deco</option>
            <option value="impressionist">Impressionist</option>
            <option value="pop-art">Pop Art</option>
            <option value="digital-painting">Digital Painting</option>
            <option value="minimalism">Minimalism</option>
        </select>
        <button class="button" id="generate">Generate Image</button>
        <button class="button" id="saveMood">Save</button>
        <button class="button" onclick="window.location.href='https://synthcalm.com'">Return to SynthCalm</button>
    </div>

    <hr style="border: none; border-top: 1px solid #0ff; margin: 20px 0;" />
    <p style="color:#0ff;font-size:14px;text-align:center;">Mood History</p>

    <div class="image-frame">
        <img id="generatedImage" alt="Generated Mood Art" />
    </div>

    <div id="moodHistory" style="min-height: 100px;"></div>
    <div id="thinking" style="display:none;text-align:center;color:#ff0;font-family:'Courier New', monospace;">Generating...</div>
</div>

<script>
    // === Clock Display ===
    function updateDateTime() {
        const now = new Date();
        const formatted = now.toLocaleString();
        document.getElementById('dateTimeDisplay').textContent = formatted;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // === Waveform Visualization ===
    const canvas = document.getElementById("waveform");
    const ctx = canvas.getContext("2d");
    canvas.width = canvas.offsetWidth;
    canvas.height = 160;

    let analyser, dataArray, audioCtx, source, micStream;

    function drawWaveform() {
        if (!analyser) {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            return;
        }
        requestAnimationFrame(drawWaveform);
        analyser.getByteTimeDomainData(dataArray);
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#ffff00";
        ctx.lineWidth = 2;
        ctx.beginPath();
        const sliceWidth = canvas.width / dataArray.length;
        let x = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const v = dataArray[i] / 128.0;
            const y = (v * canvas.height) / 2;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
            x += sliceWidth;
        }
        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
    }
    drawWaveform(); // Initial call to clear the canvas

    // === Voice Recording and Speech Recognition ===
    let recognition;
    const startBtn = document.getElementById("startVoice");
    const countdownDisplay = document.getElementById("countdownDisplay");
    let isRecording = false;
    let countdownInterval;

    startBtn.addEventListener("click", async () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("SpeechRecognition not supported in this browser. Please use Chrome or Edge.");
            return;
        }

        if (isRecording) {
            stopRecording();
            return;
        }

        // Request microphone access and set up audio context for waveform
        try {
            console.log("Requesting microphone access");
            micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            console.log("Microphone access granted");
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            source = audioCtx.createMediaStreamSource(micStream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            dataArray = new Uint8Array(analyser.fftSize);
            source.connect(analyser);
            console.log("Audio context and analyser set up");
            drawWaveform();
        } catch (err) {
            console.error("Microphone access denied:", err);
            alert("Failed to access microphone: " + err.message);
            return;
        }

        // Set up speech recognition
        try {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
                document.getElementById("activityInput").value = transcript;
                console.log("Speech recognition result:", transcript);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                if (event.error === "not-allowed") {
                    alert("Microphone access for speech recognition denied.");
                }
            };

            recognition.onend = () => {
                console.log("Speech recognition ended");
                if (isRecording) recognition.start(); // Restart if still recording
            };

            console.log("Starting speech recognition");
            recognition.start();
            isRecording = true;
            startBtn.classList.add("recording");
            startBtn.textContent = "Stop Voice";
            startCountdown();
        } catch (err) {
            console.error("Speech recognition failed to start:", err);
            alert("Failed to start speech recognition: " + err.message);
            stopRecording();
        }
    });

    function stopRecording() {
        if (recognition) recognition.stop();
        if (micStream) micStream.getTracks().forEach(track => track.stop());
        if (audioCtx) audioCtx.close();
        analyser = null; // Stop waveform
        isRecording = false;
        startBtn.classList.remove("recording");
        startBtn.textContent = "Start Voice";
        clearInterval(countdownInterval);
        countdownDisplay.textContent = "00:60";
    }

    function startCountdown() {
        let seconds = 60;
        countdownDisplay.textContent = `00:${seconds}`;
        countdownInterval = setInterval(() => {
            seconds--;
            countdownDisplay.textContent = `00:${seconds < 10 ? "0" + seconds : seconds}`;
            if (seconds <= 0) stopRecording();
        }, 1000);
    }

    // === Image Generation ===
    document.getElementById("generate").addEventListener("click", async () => {
        const mood = document.getElementById("activityInput").value.trim();
        const style = document.getElementById("styleSelect").value;
        const img = document.getElementById("generatedImage");
        const imageInput = document.getElementById('imageInput');

        if (!mood || style === "none") {
            alert("Please enter your mood and select a style.");
            return;
        }

        if(!imageInput.files[0]){
            alert("Please select an image to use.");
            return;
        }

        const imageFile = imageInput.files[0];

        document.getElementById("thinking").style.display = "block";

        try {
            const formData = new FormData();
            formData.append('image', imageFile);
            formData.append('prompt', mood + ", " + style);

            const response = await axios.post(
                'http://your-server-address:3001/generate-image', // Replace with your server's address
                formData,
                {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                    },
                }
            );

            img.src = response.data.image;
            img.style.display = "block";
            document.getElementById("thinking").style.display = "none";

        } catch (error) {
            console.error('Error generating image:', error);
            alert('Failed to generate image.');
            document.getElementById("thinking").style.display = "none";
        }
    });

    // === Save Mood to History ===
    document.getElementById("saveMood").addEventListener("click", () => {
        const moodText = document.getElementById("activityInput").value.trim();
        if (!moodText) {
            alert("Please enter a mood to save.");
            return;
        }

        const timestamp = new Date().toLocaleString();
        const img = document.getElementById("generatedImage");
        const imgSrc = img && img.src && img.style.display !== "none"
            ? img.src
            : 'https://placehold.co/40x40/000000/0ff?text=🖼️';

        const entry = document.createElement("div");
        entry.className = "history-entry";
        entry.innerHTML = `
            <img src="${imgSrc}" style="width:40px;height:40px;object-fit:cover;border:1px solid #0ff;margin-right:8px;" />
            <span style="color:#0ff;flex-grow:1;">${timestamp}: ${moodText}</span>
            <button onclick="this.parentElement.remove()" style="margin-left:8px;">Delete</button>
        `;
        entry.style.display = "flex";
        entry.style.alignItems = "center";
        entry.style.marginBottom = "8px";
        document.getElementById("moodHistory").prepend(entry);
    });

    // === Clear Input and Image ===
    document.getElementById("clear").addEventListener("click", () => {
        document.getElementById("activityInput").value = "";
        const img = document.getElementById("generatedImage");
        img.src = "";
        img.style.display = "none";
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</body>
</html>
