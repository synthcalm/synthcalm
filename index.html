<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Load Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Initialize Supabase -->
  <script>
    const SUPABASE_URL = 'https://ysuaedvcfplzzfcmmkgb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.search);
    const access_token = params.get('access_token');
    const refresh_token = params.get('refresh_token');

    if (access_token && refresh_token) {
      supabase.auth.setSession({ access_token, refresh_token })
        .then(() => window.history.replaceState({}, document.title, "/synthcalm/"));
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const loginButton = document.getElementById('login');
      const logoutButton = document.getElementById('logout');
      const { data: { session } } = await supabase.auth.getSession();
      toggleAuthButtons(session);

      loginButton.addEventListener('click', async () => {
        const email = prompt("Enter your email:");
        if (!email) return;
        const { error } = await supabase.auth.signInWithOtp({ email });
        if (error) {
          alert('Login failed. Check the email and try again.');
          console.error(error);
        } else {
          alert('Check your email for the login link!');
        }
      });

      logoutButton.addEventListener('click', async () => {
        await supabase.auth.signOut();
        toggleAuthButtons(null);
      });

      supabase.auth.onAuthStateChange((_event, session) => toggleAuthButtons(session));

      function toggleAuthButtons(session) {
        document.getElementById('login').style.display = session ? 'none' : 'inline-block';
        document.getElementById('logout').style.display = session ? 'inline-block' : 'none';
      }
    });
  </script>
</head>
<body>
  <!-- BODY CONTENT HERE: left intact -->
  <div class="divider"></div>
  <div id="moodHistory">
    <h3>MOOD HISTORY</h3>
  </div>

  <script>
    async function isUserLoggedIn() {
      const { data } = await supabase.auth.getUser();
      return !!data.user;
    }

    function canGenerateImageLocally() {
      const usageKey = 'mia_image_usage';
      const now = Date.now();
      const oneWeek = 7 * 24 * 60 * 60 * 1000;
      let usage = JSON.parse(localStorage.getItem(usageKey));

      if (!usage || now - usage.resetTime > oneWeek) {
        usage = { count: 0, resetTime: now };
        localStorage.setItem(usageKey, JSON.stringify(usage));
      }

      if (usage.count >= 3) {
        return false;
      }

      usage.count++;
      localStorage.setItem(usageKey, JSON.stringify(usage));
      return true;
    }

    generateImageButton.addEventListener('click', async () => {
      const userLoggedIn = await isUserLoggedIn();

      if (!userLoggedIn && !canGenerateImageLocally()) {
        alert('Limit reached: Please sign in to generate more than 3 images per week.');
        return;
      }

      // Continue with image generation logic
    });
  </script>
</body>
</html>
